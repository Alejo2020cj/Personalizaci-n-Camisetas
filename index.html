<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personalizar Camiseta - Cyberpunk</title>

<style>
  body {
    margin:0;
    font-family: 'Arial', sans-serif;
    background: #0d0d0d;
    color: #fff;
    text-align:center;
  }

  h1 {
    margin-top:15px;
    font-size:22px;
    letter-spacing:2px;
    color:#00f6ff;
    text-shadow:0 0 10px #00f6ff;
  }

  .controls {
    margin-top:15px;
    display:flex;
    flex-direction:column;
    gap:10px;
    padding:0 15px;
  }

  button, label {
    background:#111;
    border:1px solid #00f6ff;
    color:#00f6ff;
    padding:10px;
    border-radius:8px;
    cursor:pointer;
    width:100%;
    text-shadow:0 0 5px #00f6ff;
  }

  button:hover, label:hover {
    background:#00f6ff;
    color:#000;
    text-shadow:none;
  }

  input[type="file"] {
    display:none;
  }

  canvas {
    margin-top:20px;
    max-width:100%;
    border:2px solid #00f6ff;
    border-radius:10px;
    box-shadow:0 0 15px #00f6ff;
    background:#000;
  }
</style>

</head>
<body>

<h1>EDITOR DE CAMISETAS CYBERPUNK</h1>

<div class="controls">
  <button id="btnElla">Ellas 游녴</button>
  <button id="btnEllos">Ellos 游녯</button>

  <label for="mockupInput">Subir Mockup</label>
  <input type="file" id="mockupInput" accept="image/*">

  <label for="designInput">Subir Dise침o</label>
  <input type="file" id="designInput" accept="image/*">

  <button id="downloadBtn">Descargar Dise침o Final</button>
</div>

<canvas id="canvas"></canvas>

<script>
/* ------------------------------------------------------------------------------------
   VARIABLES PRINCIPALES
------------------------------------------------------------------------------------ */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { willReadFrequently: true });

let mockupImg = null;
let designImg = null;

let designX = 100, designY = 100;
let designW = 200, designH = 200;
let isMoving = false;
let isResizing = false;
let offsetX = 0, offsetY = 0;

/* ------------------------------------------------------------------------------------
   AJUSTAR CANVAS AL TAMA칌O DE LA IMAGEN DEL MOCKUP
------------------------------------------------------------------------------------ */
function setCanvasSizeToImage(img) {
  canvas.width = img.width;
  canvas.height = img.height;
}

/* ------------------------------------------------------------------------------------
   DIBUJAR TODO
------------------------------------------------------------------------------------ */
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (mockupImg) ctx.drawImage(mockupImg, 0, 0, canvas.width, canvas.height);
  if (designImg) ctx.drawImage(designImg, designX, designY, designW, designH);
}

/* ------------------------------------------------------------------------------------
   FUNCI칍N OPTIMIZADA (FIX CELULAR) PARA CARGAR MOCKUPS QUEMADOS
------------------------------------------------------------------------------------ */
function loadDefaultMockup(baseName){
  const exts = ['png','jpg','jpeg'];
  let i = 0;

  function tryLoad(){
    if (i >= exts.length){
      alert("No se encontr칩 " + baseName + ".png/.jpg/.jpeg");
      return;
    }

    const img = new Image();
    img.crossOrigin = "anonymous";
    img.decoding = "async";  // 游댠 FIX anti-congelamiento en m칩viles

    img.onload = async () => {
      try { await img.decode(); } catch(e){}

      // 游댠 LIBERA UI antes de dibujar (fix definitivo)
      requestAnimationFrame(() => {
        mockupImg = img;
        setCanvasSizeToImage(img);
        draw();
      });
    };

    img.onerror = () => { i++; tryLoad(); };

    img.src = `${baseName}.${exts[i]}`;
  }

  tryLoad();
}

/* ------------------------------------------------------------------------------------
   CARGAR MOCKUP DESDE ARCHIVO
------------------------------------------------------------------------------------ */
document.getElementById('mockupInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const img = new Image();
  img.onload = () => { mockupImg = img; setCanvasSizeToImage(img); draw(); };
  img.src = URL.createObjectURL(file);
});

/* ------------------------------------------------------------------------------------
   CARGAR DISE칌O
------------------------------------------------------------------------------------ */
document.getElementById('designInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const img = new Image();
  img.onload = () => { designImg = img; draw(); };
  img.src = URL.createObjectURL(file);
});

/* ------------------------------------------------------------------------------------
   BOTONES ELLOS / ELLAS (IM츼GENES QUEMADAS)
------------------------------------------------------------------------------------ */
document.getElementById('btnElla').addEventListener('click', () => {
  loadDefaultMockup('mockup_ella');
});

document.getElementById('btnEllos').addEventListener('click', () => {
  loadDefaultMockup('mockup_ellos');
});

/* ------------------------------------------------------------------------------------
   MOVIMIENTO Y REDIMENSION EN PC + M칍VIL
------------------------------------------------------------------------------------ */
canvas.addEventListener('pointerdown', e => {
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  const resizeMargin = 40;

  if (designImg &&
      x >= designX + designW - resizeMargin &&
      y >= designY + designH - resizeMargin) {

      isResizing = true;
      offsetX = x - (designX + designW);
      offsetY = y - (designY + designH);
      return;
  }

  if (designImg &&
      x >= designX && x <= designX + designW &&
      y >= designY && y <= designY + designH) {

      isMoving = true;
      offsetX = x - designX;
      offsetY = y - designY;
  }
});

canvas.addEventListener('pointermove', e => {
  if (!isMoving && !isResizing) return;

  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  if (isMoving) {
      designX = x - offsetX;
      designY = y - offsetY;
  }

  if (isResizing) {
      designW = x - designX - offsetX;
      designH = y - designY - offsetY;
  }

  draw();
});

canvas.addEventListener('pointerup', () => {
  isMoving = false;
  isResizing = false;
});

/* ------------------------------------------------------------------------------------
   DESCARGAR IMAGEN FINAL
------------------------------------------------------------------------------------ */
document.getElementById('downloadBtn').addEventListener('click', async () => {
  draw();

  try {
    await new Promise((resolve, reject) => {
      canvas.toBlob(blob => {
        if (!blob) return reject();

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'camiseta_cyberpunk.png';
        a.click();
        URL.revokeObjectURL(url);
        resolve();
      });
    });

  } catch (err) {
    alert("Error al descargar. Aseg칰rate de cargar im치genes desde GitHub Pages o servidor local.");
  }
});
</script>

</body>
</html>
