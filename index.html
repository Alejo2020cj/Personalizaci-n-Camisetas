
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dise√±ador Cyberpunk de Camisetas</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --neon1:#ff00cc; --neon2:#00e5ff; --bg:#04040a;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    background:radial-gradient(circle at top left,var(--bg),#0b0b12);
    color:#fff;
    font-family:'Orbitron',sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
    padding:12px;
  }
  header{
    width:100%;
    text-align:center;
    padding:14px;
    background:linear-gradient(90deg,var(--neon1),var(--neon2));
    box-shadow:0 6px 30px rgba(0,0,0,0.4);
    border-radius:8px;
    font-size:1.2rem;
  }

  /* CONTROLES: dise√±o responsivo: fila que envuelve */
  .controls{
    width:100%;
    max-width:1000px;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:center;
    align-items:center;
    padding:8px;
  }

  .controls > * {
    /* para inputs y botones tama√±o consistente */
    min-width:120px;
  }

  button, .file-label {
    background: linear-gradient(90deg,var(--neon1),var(--neon2));
    color: #000;
    border: none;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    font-weight:700;
    box-shadow:0 8px 20px rgba(0,0,0,0.35);
    text-align:center;
  }

  /* file input hidden, label styled as button */
  input[type="file"]{ display:none; }

  .file-label{
    display:inline-block;
  }

  /* small helper styling */
  .small {
    background: transparent;
    border: 1px dashed rgba(0,229,255,0.12);
    color: rgba(255,255,255,0.9);
    padding:8px 10px;
    border-radius:8px;
    min-width:150px;
  }

  /* canvas container */
  .canvas-wrap{
    width:100%;
    max-width:900px;
    display:flex;
    justify-content:center;
    align-items:center;
  }

  canvas{
    width:100%;
    height:auto;
    max-height:78vh;
    border-radius:12px;
    border:2px solid rgba(0,229,255,0.12);
    box-shadow:0 10px 40px rgba(0,0,0,0.6);
    background:#0b0b0b;
    touch-action:none; /* importante para touch */
  }

  .hint{ color:#cfe9ff88; font-size:0.9rem; text-align:center; max-width:900px; }

  /* peque√±os ajustes responsive */
  @media (max-width:540px){
    .controls > * { min-width: 48%; }
    .controls { gap:8px; }
  }
</style>
</head>
<body>
  <header>üëï Dise√±ador Cyberpunk ‚Äî Personaliza tu Camiseta</header>

  <div class="controls">
    <!-- Mockups predeterminados -->
    <button id="btnEllas">üëö Ellas</button>
    <button id="btnEllos">üëï Ellos</button>

    <!-- Subir mockup propio -->
    <label class="file-label" for="mockupInput">üì§ Subir mockup</label>
    <input id="mockupInput" type="file" accept="image/*">

    <!-- Subir arte/dise√±o -->
    <label class="file-label" for="artInput">üñºÔ∏è Subir dise√±o</label>
    <input id="artInput" type="file" accept="image/*">

    <!-- Descargar y Reset -->
    <button id="downloadBtn">‚¨áÔ∏è Descargar PNG</button>
    <button id="resetBtn">‚Ü∫ Reiniciar</button>
  </div>

  <div class="canvas-wrap">
    <canvas id="canvas" width="800" height="1000"></canvas>
  </div>

  <div class="hint">Toca/arrastra para mover. Arrastra cualquier borde o esquina para redimensionar. Compatible PC y m√≥vil.</div>

<script>
/* =========================
   Variables DOM
   ========================= */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const btnEllas = document.getElementById('btnEllas');
const btnEllos  = document.getElementById('btnEllos');
const mockupInput = document.getElementById('mockupInput');
const artInput = document.getElementById('artInput');
const downloadBtn = document.getElementById('downloadBtn');
const resetBtn = document.getElementById('resetBtn');

/* =========================
   Estado de im√°genes y dise√±o
   ========================= */
let mockupImg = null; // imagen base (mockup)
let artImg = null;    // imagen del dise√±o

// cuadro del arte en coordenadas BITMAP (no DOM)
let art = { x: 100, y: 150, w: 300, h: 300 };

/* interacci√≥n */
let pointerDown = false;
let activePointerId = null;
let dragging = false;
let resizing = false;
let resizeDir = null;
let dragOffset = {x:0,y:0};

const HANDLE_MARGIN = 20;
const MIN_SIZE = 30;

/* =========================
   Helpers: set canvas size to image (DPR aware)
   ========================= */
function setCanvasSizeToImage(img){
  const dpr = window.devicePixelRatio || 1;
  canvas.width = img.width * dpr;
  canvas.height = img.height * dpr;
  canvas.style.width = Math.min(img.width, window.innerWidth - 40) + 'px';
  // keep height auto; browser will scale by aspect ratio
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

/* =========================
   Dibujado
   ========================= */
function draw(){
  // limpiar bitmap
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // dibujar mockup a tama√±o l√≥gico
  if (mockupImg) {
    ctx.drawImage(mockupImg, 0, 0, canvas.width / (window.devicePixelRatio || 1), canvas.height / (window.devicePixelRatio || 1));
  } else {
    // si no hay mockup, fondo neutro
    ctx.fillStyle = '#0b0b0b';
    ctx.fillRect(0,0,canvas.width/(window.devicePixelRatio||1), canvas.height/(window.devicePixelRatio||1));
  }

  // dibujar arte si existe
  if (artImg) {
    ctx.drawImage(artImg, art.x, art.y, art.w, art.h);
  }

  // borde selecci√≥n
  if (artImg && (dragging || resizing || pointerDown)) {
    ctx.strokeStyle = '#00ffff';
    ctx.lineWidth = 2;
    ctx.strokeRect(art.x, art.y, art.w, art.h);
    // dibujar manejador en esquina inferior derecha
    const hs = HANDLE_MARGIN;
    ctx.fillStyle = '#ff00cc';
    ctx.fillRect(art.x + art.w - hs/2, art.y + art.h - hs/2, hs, hs);
  }
}

/* =========================
   Coordenadas: convertir client -> bitmap coords del canvas
   ========================= */
function getPointerPos(evt){
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  const clientX = (evt.clientX !== undefined) ? evt.clientX : (evt.touches && evt.touches[0] && evt.touches[0].clientX);
  const clientY = (evt.clientY !== undefined) ? evt.clientY : (evt.touches && evt.touches[0] && evt.touches[0].clientY);
  return {
    x: (clientX - rect.left) * (canvas.width / rect.width) / dpr,
    y: (clientY - rect.top)  * (canvas.height / rect.height) / dpr
  };
}

/* =========================
   Detecci√≥n: dentro del arte o zona de resize
   ========================= */
function isInsideArt(p){
  return p.x >= art.x && p.x <= art.x + art.w && p.y >= art.y && p.y <= art.y + art.h;
}
function getResizeDirection(p){
  const nearLeft = Math.abs(p.x - art.x) < HANDLE_MARGIN;
  const nearRight = Math.abs(p.x - (art.x + art.w)) < HANDLE_MARGIN;
  const nearTop = Math.abs(p.y - art.y) < HANDLE_MARGIN;
  const nearBottom = Math.abs(p.y - (art.y + art.h)) < HANDLE_MARGIN;
  if (nearTop && nearLeft) return 'nw';
  if (nearTop && nearRight) return 'ne';
  if (nearBottom && nearLeft) return 'sw';
  if (nearBottom && nearRight) return 'se';
  if (nearTop) return 'n';
  if (nearBottom) return 's';
  if (nearLeft) return 'w';
  if (nearRight) return 'e';
  return null;
}

/* =========================
   Pointer events (mouse + touch)
   ========================= */
canvas.addEventListener('pointerdown', (ev) => {
  ev.preventDefault();
  // if another pointer active, ignore (simple multi-touch protection)
  if (activePointerId !== null && activePointerId !== ev.pointerId) return;
  activePointerId = ev.pointerId;
  canvas.setPointerCapture(activePointerId);

  pointerDown = true;
  const pos = getPointerPos(ev);
  const dir = getResizeDirection(pos);

  if (artImg && dir) {
    resizing = true; resizeDir = dir;
  } else if (artImg && isInsideArt(pos)) {
    dragging = true;
    dragOffset.x = pos.x - art.x;
    dragOffset.y = pos.y - art.y;
  } else {
    // toc√≥ fuera -> deseleccionar
    dragging = false; resizing = false;
  }
  draw();
});

canvas.addEventListener('pointermove', (ev) => {
  const pos = getPointerPos(ev);
  const dir = getResizeDirection(pos);
  if (dir) canvas.style.cursor = dir + '-resize';
  else if (artImg && isInsideArt(pos)) canvas.style.cursor = 'move';
  else canvas.style.cursor = 'default';

  if (!pointerDown || activePointerId !== ev.pointerId) return;
  ev.preventDefault();

  if (dragging) {
    art.x = pos.x - dragOffset.x;
    art.y = pos.y - dragOffset.y;
  } else if (resizing) {
    const dx = pos.x - art.x;
    const dy = pos.y - art.y;
    switch (resizeDir) {
      case 'n': art.h += art.y - pos.y; art.y = pos.y; break;
      case 's': art.h = dy; break;
      case 'w': art.w += art.x - pos.x; art.x = pos.x; break;
      case 'e': art.w = dx; break;
      case 'nw': art.w += art.x - pos.x; art.h += art.y - pos.y; art.x = pos.x; art.y = pos.y; break;
      case 'ne': art.w = dx; art.h += art.y - pos.y; art.y = pos.y; break;
      case 'sw': art.w += art.x - pos.x; art.x = pos.x; art.h = dy; break;
      case 'se': art.w = dx; art.h = dy; break;
    }
    if (art.w < MIN_SIZE) art.w = MIN_SIZE;
    if (art.h < MIN_SIZE) art.h = MIN_SIZE;
  }
  draw();
});

function endPointer(ev){
  if (activePointerId !== ev.pointerId) return;
  dragging = resizing = false;
  pointerDown = false;
  resizeDir = null;
  try { canvas.releasePointerCapture(activePointerId); } catch(e){}
  activePointerId = null;
  // UX: ocultar borde al soltar (si prefieres mantenerlo, cambia a selected=true)
  draw();
}
canvas.addEventListener('pointerup', endPointer);
canvas.addEventListener('pointercancel', endPointer);
canvas.addEventListener('pointerout', endPointer);

/* =========================
   Load default mockup helper:
   intenta png -> jpg -> jpeg (soporta archivos quemados con distintas extensiones)
   ========================= */
function loadDefaultMockup(baseName){
  const tryExt = (ext, onLoad, onError) => {
    const i = new Image();
    i.crossOrigin = 'anonymous'; // intentar permitir export si el recurso lo permite
    i.onload = () => onLoad(i);
    i.onerror = onError;
    i.src = baseName + '.' + ext;
  };
  tryExt('png', (img)=>{ mockupImg = img; setCanvasSizeToImage(img); draw(); }, ()=>{
    tryExt('jpg', (img)=>{ mockupImg = img; setCanvasSizeToImage(img); draw(); }, ()=>{
      tryExt('jpeg', (img)=>{ mockupImg = img; setCanvasSizeToImage(img); draw(); }, ()=>{
        alert('No se encontr√≥ ' + baseName + '.png/.jpg/.jpeg en la carpeta. Coloca el archivo junto a index.html.');
      });
    });
  });
}

/* =========================
   BOTONES Ellas / Ellos
   - Cambia aqu√≠ los nombres base si tus archivos se llaman distinto
   ========================= */
const DEFAULT_ELLAS = 'mockup_ellas'; // <- coloca el nombre base (sin extensi√≥n) si tus archivos se llaman diferente
const DEFAULT_ELLOS = 'mockup_ellos';

btnEllas.addEventListener('click', ()=> loadDefaultMockup(DEFAULT_ELLAS));
btnEllos.addEventListener('click', ()=> loadDefaultMockup(DEFAULT_ELLOS));

/* =========================
   SUBIR MOCKUP PROPIO (input file)
   ========================= */
mockupInput.addEventListener('change', (e) => {
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  const i = new Image();
  i.onload = () => { mockupImg = i; setCanvasSizeToImage(i); draw(); URL.revokeObjectURL(url); };
  i.onerror = () => { alert('No se pudo cargar el mockup.'); URL.revokeObjectURL(url); };
  i.src = url;
});

/* =========================
   SUBIR ARTE / DISE√ëO
   ========================= */
artInput.addEventListener('change', (e) => {
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  const i = new Image();
  i.onload = () => {
    artImg = i;
    // escalar arte al 40% del ancho l√≥gico del canvas
    const cw = canvas.width / (window.devicePixelRatio || 1);
    art.w = cw * 0.4;
    art.h = art.w * (i.height / i.width);
    art.x = (cw - art.w) / 2;
    art.y = (canvas.height / (window.devicePixelRatio || 1) - art.h) / 2;
    draw();
    URL.revokeObjectURL(url);
  };
  i.onerror = () => { alert('No se pudo cargar el dise√±o.'); URL.revokeObjectURL(url); };
  i.src = url;
});

/* =========================
   DESCARGA ROBUSTA
   ========================= */
downloadBtn.addEventListener('click', async () => {
  draw();
  // intento toBlob
  try {
    await new Promise((resolve, reject) => {
      canvas.toBlob((blob) => {
        if (!blob) {
          reject(new Error('toBlob returned null'));
          return;
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'camiseta_cyberpunk.png';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        resolve();
      }, 'image/png');
    });
    return;
  } catch (err) {
    console.warn('toBlob fall√≥:', err);
  }

  // fallback toDataURL
  try {
    const dataUrl = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = dataUrl; a.download = 'camiseta_cyberpunk.png';
    document.body.appendChild(a); a.click(); a.remove();
    return;
  } catch (err) {
    console.error('toDataURL fall√≥ (canvas probablemente tainted):', err);
    alert(
      'No se pudo descargar la imagen. Esto suele ocurrir por restricciones CORS en las im√°genes.\n\n' +
      'Soluciones:\n' +
      '‚Ä¢ Aseg√∫rate de que los mockups quemados est√©n en la MISMA carpeta que index.html y utiliza el servidor local o GitHub Pages.\n' +
      '‚Ä¢ Si pruebas con archivos locales, ejecuta un servidor simple: `python -m http.server` o `npx http-server` y abre http://localhost:8000\n' +
      'Revisa la consola del navegador para m√°s detalles.'
    );
  }
});

/* =========================
   RESET
   ========================= */
resetBtn.addEventListener('click', ()=>{
  mockupImg = null; artImg = null;
  art = { x:100, y:150, w:300, h:300 };
  const dpr = window.devicePixelRatio || 1;
  canvas.width = 800 * dpr; canvas.height = 1000 * dpr;
  canvas.style.width = Math.min(800, window.innerWidth - 40) + 'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
  draw();
});

/* =========================
   Inicializar canvas por defecto
   ========================= */
(function init(){
  const dpr = window.devicePixelRatio || 1;
  canvas.width = 800 * dpr;
  canvas.height = 1000 * dpr;
  canvas.style.width = Math.min(800, window.innerWidth - 40) + 'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
  draw();
})();
</script>
</body>
</html>
